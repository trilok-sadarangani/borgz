services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: borgz
      POSTGRES_USER: borgz
      POSTGRES_PASSWORD: borgz
    ports:
      - "5432:5432"
    volumes:
      - borgz-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U borgz -d borgz"]
      interval: 3s
      timeout: 3s
      retries: 30

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      NODE_ENV: production
      PORT: 3001
      CORS_ORIGIN: http://localhost:8081
      DATABASE_URL: postgresql://borgz:borgz@db:5432/borgz?schema=public
      ENABLE_DB_PERSISTENCE: "true"
      # Local docker-compose can reuse an existing DB volume that already has tables.
      # In that case, `prisma migrate deploy` fails with P3005 ("schema is not empty").
      # Use db push for local dev to keep restarts smooth.
      PRISMA_SYNC_MODE: dbpush
      AUTH0_DOMAIN: dev-hl2hhkyfntxf14em.us.auth0.com
      AUTH0_AUDIENCE: api.borgz.com
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy

volumes:
  borgz-db:


