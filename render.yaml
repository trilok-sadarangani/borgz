# ===================
# PRODUCTION SERVICES
# ===================
# NOTE: The backend now serves both the API and the web client (SPA).
# This provides a single deployment with proper SPA routing support.
services:
  - type: web
    name: borgz-backend
    env: docker
    rootDir: .
    dockerContext: .
    dockerfilePath: backend/Dockerfile
    plan: standard
    autoDeploy: true
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: ENABLE_DB_PERSISTENCE
        value: "true"
      - key: DISABLE_SEED_AUTH
        value: "true"
      # CORS can be more permissive since frontend is same-origin, but keep for socket.io
      - key: CORS_ORIGIN
        value: https://borgz-backend.onrender.com
      - key: DATABASE_URL
        fromDatabase:
          name: borgz-db
          property: connectionString
      - key: AUTH0_DOMAIN
        value: dev-hl2hhkyfntxf14em.us.auth0.com
      - key: AUTH0_AUDIENCE
        value: api.borgz.com
      - key: AUTH0_ISSUER
        value: https://dev-hl2hhkyfntxf14em.us.auth0.com/
      # NOTE: Client env vars (EXPO_PUBLIC_*) are read from client/app.json at build time.
      # The API URL uses same-origin detection (empty string = relative URLs).
      # Auth0 config is read from app.json's expo.extra values.

  # =================
  # STAGING SERVICES
  # =================
  - type: web
    name: borgz-backend-staging
    env: docker
    rootDir: .
    dockerContext: .
    dockerfilePath: backend/Dockerfile
    plan: starter
    autoDeploy: true
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: staging
      - key: ENABLE_DB_PERSISTENCE
        value: "true"
      - key: DISABLE_SEED_AUTH
        value: "true"
      - key: CORS_ORIGIN
        value: https://borgz-backend-staging.onrender.com
      - key: DATABASE_URL
        fromDatabase:
          name: borgz-db-staging
          property: connectionString
      - key: AUTH0_DOMAIN
        value: dev-hl2hhkyfntxf14em.us.auth0.com
      - key: AUTH0_AUDIENCE
        value: api.borgz.com
      - key: AUTH0_ISSUER
        value: https://dev-hl2hhkyfntxf14em.us.auth0.com/
      # NOTE: Client env vars (EXPO_PUBLIC_*) are read from client/app.json at build time.
      # The API URL uses same-origin detection (empty string = relative URLs).
      # Auth0 config is read from app.json's expo.extra values.

# =========
# DATABASES
# =========
databases:
  - name: borgz-db
    plan: basic-256mb

  - name: borgz-db-staging
    plan: basic-256mb
